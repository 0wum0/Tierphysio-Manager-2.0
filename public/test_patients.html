<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Patient API Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #8b5cf6;
            padding-bottom: 10px;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success {
            color: green;
            font-weight: bold;
        }
        .error {
            color: red;
            font-weight: bold;
        }
        .patient-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #fafafa;
        }
        .patient-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #4b5563;
        }
        .owner-info {
            color: #8b5cf6;
            margin-top: 5px;
        }
        .no-owner {
            color: #9ca3af;
            font-style: italic;
        }
        pre {
            background: #f3f4f6;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        button {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #7c3aed;
        }
    </style>
</head>
<body>
    <h1>üêæ Tierphysio Manager - Patient API Test</h1>
    
    <div class="test-section">
        <h2>API Endpoint Tests</h2>
        <button onclick="testAPI('api/patients.php')">Test Haupt-API</button>
        <button onclick="testAPI('api/patients_mock.php')">Test Mock-API</button>
        <button onclick="testAPI('api_patients.php')">Test Wrapper-API</button>
    </div>
    
    <div class="test-section">
        <h2>Test Results</h2>
        <div id="status"></div>
        <div id="results"></div>
    </div>
    
    <div class="test-section">
        <h2>Raw JSON Response</h2>
        <pre id="json-output"></pre>
    </div>

    <script>
        async function testAPI(endpoint) {
            const statusEl = document.getElementById('status');
            const resultsEl = document.getElementById('results');
            const jsonEl = document.getElementById('json-output');
            
            statusEl.innerHTML = '<p>Testing endpoint: <strong>' + endpoint + '?action=list</strong></p>';
            resultsEl.innerHTML = '<p>Loading...</p>';
            jsonEl.textContent = '';
            
            try {
                const response = await fetch(endpoint + '?action=list');
                const text = await response.text();
                
                // Try to parse as JSON
                let data;
                try {
                    data = JSON.parse(text);
                    jsonEl.textContent = JSON.stringify(data, null, 2);
                } catch (parseError) {
                    statusEl.innerHTML += '<p class="error">‚ùå Response is not valid JSON!</p>';
                    jsonEl.textContent = text;
                    return;
                }
                
                // Check response structure
                if (data.ok === true) {
                    statusEl.innerHTML += '<p class="success">‚úÖ API responded with ok=true</p>';
                    
                    if (data.items && Array.isArray(data.items)) {
                        statusEl.innerHTML += '<p class="success">‚úÖ Response contains items array</p>';
                        statusEl.innerHTML += '<p>Found ' + data.items.length + ' patients</p>';
                        
                        // Display patients
                        let html = '<h3>Patients with Owners:</h3>';
                        data.items.forEach(patient => {
                            html += '<div class="patient-card">';
                            html += '<div class="patient-name">üêæ ' + (patient.patient_name || patient.name || 'Unknown') + '</div>';
                            html += '<div>Species: ' + (patient.species || 'unknown') + '</div>';
                            
                            if (patient.owner_name && patient.owner_name !== '‚Äî') {
                                html += '<div class="owner-info">üë§ Owner: ' + patient.owner_name + '</div>';
                                if (patient.owner_customer_number) {
                                    html += '<div>Customer #: ' + patient.owner_customer_number + '</div>';
                                }
                            } else {
                                html += '<div class="no-owner">No owner assigned</div>';
                            }
                            html += '</div>';
                        });
                        
                        resultsEl.innerHTML = html;
                        
                        // Check for owner_name field
                        const hasOwnerName = data.items.every(item => 'owner_name' in item);
                        if (hasOwnerName) {
                            statusEl.innerHTML += '<p class="success">‚úÖ All items have owner_name field</p>';
                        } else {
                            statusEl.innerHTML += '<p class="error">‚ùå Some items missing owner_name field</p>';
                        }
                        
                    } else {
                        statusEl.innerHTML += '<p class="error">‚ùå No items array in response</p>';
                    }
                } else {
                    statusEl.innerHTML += '<p class="error">‚ùå API responded with error</p>';
                    if (data.error) {
                        statusEl.innerHTML += '<p>Error message: ' + data.error + '</p>';
                    }
                }
                
            } catch (error) {
                statusEl.innerHTML += '<p class="error">‚ùå Failed to fetch: ' + error.message + '</p>';
                jsonEl.textContent = 'Error: ' + error.message;
            }
        }
        
        // Test main API on load
        window.onload = () => {
            testAPI('api/patients.php');
        };
    </script>
</body>
</html>